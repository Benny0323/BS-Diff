# BS-Diff: Effective Bone Suppression in CXRs via Conditional Diffusion Models

<div align="center">
[![](https://img.shields.io/github/stars/Benny0323/BS-Diff)](https://github.com/Benny0323/BS-Diff)
[![](https://img.shields.io/github/forks/Benny0323/BS-Diff)](https://github.com/Benny0323/BS-Diff)
[![](https://img.shields.io/github/issues/Benny0323/BS-Diff)](https://github.com/Benny0323/BS-Diff)
[![](https://img.shields.io/github/license/Benny0323/BS-Diff)](https://github.com/Benny0323/BS-Diff/blob/main/LICENSE) 
</div>

<div align=center><img width="500" height="500" src="https://github.com/Benny0323/BS-Diff/assets/104205136/e8edb3b0-559d-4a61-90ac-9a6ea53e7a4e)"/></div>

### ðŸ§¨ Congratulations! Our paper has been accepted by ISBI 2024(Oral Presentation)!

## Proposed method 

We spend a lot of time collecting and summarizing relevant papers and datasets, where you can find them at https://github.com/diaoquesang/A-detailed-summarization-about-bone-suppression-in-Chest-X-rays

This code is a PyTorch implementation of our paper "BS-Diff: Effective Bone Suppression in CXRs via Conditional Diffusion Models".

Our proposed framework comprises two stages: **a conditional diffusion model (CDM) equipped with a U-Net architecture and a simple enhancement module** that incorporates an autoencoder. It can not only generate soft tissue images with **a high bone suppression ratio** but also possess the capability to **capture fine image information and spatial features,
while preserving overall structures**. The figure below shows our proposed network.

![image](https://github.com/Benny0323/BS/blob/main/framework.png)

## The bone-suppressed images generated by our method
![image](https://github.com/Benny0323/BS/blob/main/contrast.png)

## Comparison performance with previous works (visualization)
![image](https://github.com/Benny0323/BS/blob/main/Comparison.png)

## Clinical evaluation
The results below demonstrated that our soft-tissues can **clearly preserve the visibility of pulmonary vessels and central airways and greatly suppress bones**, significantly improving the clinicianâ€™s performance in finding lung lesions. Each criterion has a maximum score of 3.
<table align="center">
<thead align="center" valign="center">
  <tr>
    <th colspan="2">Clinical Evaluation Criteria</th>
    <th>Junior clinian</th>
    <th>Intermediate clinian</th>
    <th>Senior clinian</th>
  </tr>
</thead>
<tbody align="center" valign="center">
  <tr>
    <td rowspan="3">Pulmonary<br><br>vessels<br><br>visibility</td>
    <td>Clearly displayed (3)</td>
    <td rowspan="3">2</td>
    <td rowspan="3">3</td>
    <td rowspan="3">3</td>
  </tr>
  <tr>
    <td>Displayed (2)</td>
  </tr>
  <tr>
    <td>Not displayed (1)</td>
  </tr>
  <tr>
    <td rowspan="3">Central<br><br>airway<br><br>visibility</td>
    <td>Lobar and intermediate bronchi (3)</td>
    <td rowspan="3">2</td>
    <td rowspan="3">3</td>
    <td rowspan="3">2</td>
  </tr>
  <tr>
    <td>Main bronchus and rump (2)</td>
  </tr>
  <tr>
    <td>Trachea (1)</td>
  </tr>
  <tr>
    <td rowspan="3">Degree of<br><br>bone sup-<br><br>pression</td>
    <td>Nearly perfect suppression (3)</td>
    <td rowspan="3">2</td>
    <td rowspan="3">3</td>
    <td rowspan="3">2</td>
  </tr>
  <tr>
    <td>Unsuppressed bones less than 5 (2)</td>
  </tr>
  <tr>
    <td>5 or more bones unsuppressed (1)</td>
  </tr>
</tbody>
</table>

## Pre-requisties
* Linux

* Python>=3.7

* NVIDIA GPU (memory>=6G) + CUDA cuDNN

### Download the dataset
Now, we only provide three paired images with CXRs and soft-tissues via pre-processing. Soon, we will make them available to the public after data usage permission. Three paired images are located at
```
â”œâ”€ Data
â”‚    â”œâ”€ BS_Aug
â”‚    â”‚    â”œâ”€ 0.png
â”‚    â”‚    â”œâ”€ 1.png
â”‚    â”‚    â””â”€ 2.png
â”‚    â”œâ”€ CXR_Aug
â”‚    â”‚    â”œâ”€ 0.png
â”‚    â”‚    â”œâ”€ 1.png
â”‚    â”‚    â””â”€ 2.png
```

## Getting started to evaluate
### Install dependencies
```
pip install -r requirements.txt
```
### Download the checkpoint
Due to the fact that our proposed model comprises two stages, you need to download both stages' checkpoints to successfully run the codes!
These two files can be found in the following link : 

https://drive.google.com/drive/folders/1cDlXJ7Sh4k05aM_tvzor9_F_TPCeIGMN?usp=sharing

### Evaluation
To do the evaluation process, first run the following command in stage 1 (the conditional diffusion model):
```
python Test.py
```      
Then, you will get a series of images generated by the conditional diffusion model. After that, run the following command in stage 2 with these images as inputs.
```
python Hybrid_autoencodereval.py
```
## Train by yourself
If you want to train our model by yourself, you are primarily expected to split the whole dataset into training, validation, and testing. You can find the codes in **Data Spliting** directory and run the following commands one by one:
```
python txt.py
python split.py
```
Then, you can run the following command in stage 1:
```
python Train.py
```
Then after finishing stage 1, you can use the generated output of stage 1 to train our stage (enhancement module) by running the following command:
```
python Hybridloss_autoencoder.py
```
These two files are located at
```
â”œâ”€ Stage1
â”‚    â””â”€ Train.py
â”œâ”€ Stage2
â”‚    â”œâ”€ Hybridloss_autoencoder.py
â”‚    â””â”€ pytorch_msssim.py
```

## Evaluation metrics
You can also run the following commands about evaluation metrics in our experiment including PSNR, SSIM, MSE and BSR:
```
python metrics.py
```
## Citation
```
@inproceedings{chen2024bs,
  title={BS-Diff: Effective Bone Suppression Using Conditional Diffusion Models From Chest X-Ray Images},
  author={Chen, Zhanghao and Sun, Yifei and Ge, Ruiquan and Qin, Wenjian and Pan, Cheng and Deng, Wenming and Liu, Zhou and Min, Wenwen and Elazab, Ahmed and Wan, Xiang and others},
  booktitle={2024 IEEE International Symposium on Biomedical Imaging (ISBI)},
  pages={1--5},
  year={2024},
  organization={IEEE}
}
```
## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=Benny0323/BS-Diff&type=Timeline)](https://star-history.com/#Benny0323/BS-Diff&Timeline)
